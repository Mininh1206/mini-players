---
import Layout from "@/layouts/Layout.astro";
---

<Layout
  title="Tres en Raya - MiniPlayers"
  description="El clásico Tres en Raya. Juega partidas rápidas contra un amigo en el mismo dispositivo."
  image="/images/games/tictactoe/placeholder.webp"
>
  <div class="flex flex-col items-center justify-center min-h-[60vh]">
    <h1 class="text-4xl font-bold mb-8 text-gray-900 dark:text-white">
      Tres en Raya
    </h1>

    <div
      class="mb-4 text-2xl font-semibold text-gray-700 dark:text-gray-300"
      id="status"
    >
      Turno de: <span class="text-blue-500">X</span>
    </div>

    <div
      class="grid grid-cols-3 gap-2 bg-gray-300 dark:bg-gray-700 p-2 rounded-lg"
      id="board"
    >
      <!-- Cells will be generated by JS -->
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="0"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="1"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="2"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="3"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="4"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="5"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="6"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="7"
      >
      </div>
      <div
        class="cell w-24 h-24 bg-white dark:bg-gray-800 rounded flex items-center justify-center text-5xl font-bold cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition"
        data-index="8"
      >
      </div>
    </div>

    <button
      id="resetBtn"
      class="mt-8 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition hidden"
    >
      Jugar de nuevo
    </button>
  </div>

  <script>
    const cells = document.querySelectorAll(".cell");
    const statusText = document.getElementById("status") as HTMLDivElement;
    const resetBtn = document.getElementById("resetBtn") as HTMLButtonElement;
    type Player = "X" | "O";
    let currentPlayer: Player = "X";
    let board: string[] = ["", "", "", "", "", "", "", "", ""];
    let gameActive = true;

    const winningConditions = [
      [0, 1, 2],
      [3, 4, 5],
      [6, 7, 8],
      [0, 3, 6],
      [1, 4, 7],
      [2, 5, 8],
      [0, 4, 8],
      [2, 4, 6],
    ];

    function handleCellClick(e: Event) {
      const clickedCell = e.target as HTMLDivElement;
      const indexStr = clickedCell.getAttribute("data-index");
      if (!indexStr) return;

      const clickedCellIndex = parseInt(indexStr);

      if (board[clickedCellIndex] !== "" || !gameActive) {
        return;
      }

      updateCell(clickedCell, clickedCellIndex);
      checkResult();
    }

    function updateCell(cell: HTMLDivElement, index: number) {
      board[index] = currentPlayer;
      cell.textContent = currentPlayer;
      cell.classList.add(
        currentPlayer === "X" ? "text-blue-500" : "text-red-500",
      );
    }

    function changePlayer() {
      currentPlayer = currentPlayer === "X" ? "O" : "X";
      statusText.innerHTML = `Turno de: <span class="${currentPlayer === "X" ? "text-blue-500" : "text-red-500"}">${currentPlayer}</span>`;
    }

    function checkResult() {
      let roundWon = false;
      for (let i = 0; i < winningConditions.length; i++) {
        const winCondition = winningConditions[i];
        let a = board[winCondition[0]];
        let b = board[winCondition[1]];
        let c = board[winCondition[2]];

        if (a === "" || b === "" || c === "") {
          continue;
        }
        if (a === b && b === c) {
          roundWon = true;
          break;
        }
      }

      if (roundWon) {
        statusText.innerHTML = `¡Jugador <span class="${currentPlayer === "X" ? "text-blue-500" : "text-red-500"}">${currentPlayer}</span> ha ganado!`;
        gameActive = false;
        resetBtn.classList.remove("hidden");
        return;
      }

      let roundDraw = !board.includes("");
      if (roundDraw) {
        statusText.textContent = "¡Empate!";
        gameActive = false;
        resetBtn.classList.remove("hidden");
        return;
      }

      changePlayer();
    }

    function resetGame() {
      currentPlayer = "X";
      board = ["", "", "", "", "", "", "", "", ""];
      gameActive = true;
      statusText.innerHTML = `Turno de: <span class="text-blue-500">X</span>`;
      cells.forEach((cell) => {
        cell.textContent = "";
        cell.classList.remove("text-blue-500", "text-red-500");
      });
      resetBtn.classList.add("hidden");
    }

    cells.forEach((cell) => cell.addEventListener("click", handleCellClick));
    resetBtn.addEventListener("click", resetGame);
  </script>
</Layout>
