---
import Layout from "@/layouts/Layout.astro";
---

<Layout title="Juego de Memoria - MiniPlayers">
  <div class="flex flex-col items-center justify-center min-h-[60vh] p-4">
    <h1 class="text-4xl font-bold mb-8 text-gray-900 dark:text-white">
      Juego de Memoria
    </h1>

    <!-- Mode Selection -->
    <div id="mode-selection" class="flex flex-col gap-4 text-center">
      <h2 class="text-2xl text-gray-700 dark:text-gray-300 mb-4">
        Selecciona el modo de juego
      </h2>
      <div class="flex gap-4">
        <button
          id="btn-1p"
          class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-lg"
        >
          1 Jugador
        </button>
        <button
          id="btn-2p"
          class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition shadow-lg"
        >
          2 Jugadores
        </button>
      </div>
    </div>

    <!-- Game Area (Hidden initially) -->
    <div id="game-area" class="hidden flex-col items-center w-full max-w-2xl">
      <!-- HUD -->
      <div
        class="flex justify-between w-full mb-6 text-xl font-bold text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow"
      >
        <div id="hud-1p" class="hidden w-full flex justify-between">
          <span>Tiempo: <span id="timer">00:00</span></span>
          <span>Movimientos: <span id="moves">0</span></span>
        </div>
        <div
          id="hud-2p"
          class="hidden w-full flex justify-between items-center"
        >
          <div id="p1-score" class="text-blue-500">J1: 0</div>
          <div id="turn-indicator" class="text-lg">
            Turno de: <span class="text-blue-500">J1</span>
          </div>
          <div id="p2-score" class="text-gray-500">J2: 0</div>
        </div>
      </div>

      <!-- Grid -->
      <div id="grid" class="grid grid-cols-4 gap-3 sm:gap-4 mb-8">
        <!-- Cards generated by JS -->
      </div>

      <!-- Game Over Modal / Message -->
      <div
        id="game-over"
        class="hidden flex-col items-center text-center bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 w-[90%] max-w-md"
      >
        <h2 class="text-3xl font-bold mb-4 text-gray-900 dark:text-white">
          Â¡Juego Terminado!
        </h2>
        <p
          id="result-message"
          class="text-xl mb-6 text-gray-700 dark:text-gray-300"
        >
        </p>
        <button
          id="restart-btn"
          class="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition"
        >
          Jugar de nuevo
        </button>
      </div>

      <button
        id="back-btn"
        class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 underline mt-4"
      >
        Volver al menÃº
      </button>
    </div>
  </div>

  <script>
    // Elements
    const modeSelection = document.getElementById(
      "mode-selection",
    ) as HTMLDivElement;
    const gameArea = document.getElementById("game-area") as HTMLDivElement;
    const btn1p = document.getElementById("btn-1p") as HTMLButtonElement;
    const btn2p = document.getElementById("btn-2p") as HTMLButtonElement;
    const grid = document.getElementById("grid") as HTMLDivElement;
    const hud1p = document.getElementById("hud-1p") as HTMLDivElement;
    const hud2p = document.getElementById("hud-2p") as HTMLDivElement;
    const timerDisplay = document.getElementById("timer") as HTMLSpanElement;
    const movesDisplay = document.getElementById("moves") as HTMLSpanElement;
    const p1ScoreDisplay = document.getElementById(
      "p1-score",
    ) as HTMLDivElement;
    const p2ScoreDisplay = document.getElementById(
      "p2-score",
    ) as HTMLDivElement;
    const turnIndicator = document.getElementById(
      "turn-indicator",
    ) as HTMLDivElement;
    const gameOverModal = document.getElementById(
      "game-over",
    ) as HTMLDivElement;
    const resultMessage = document.getElementById(
      "result-message",
    ) as HTMLParagraphElement;
    const restartBtn = document.getElementById(
      "restart-btn",
    ) as HTMLButtonElement;
    const backBtn = document.getElementById("back-btn") as HTMLButtonElement;

    // Game State
    type GameMode = "1p" | "2p" | null;
    let mode: GameMode = null;
    let cards: string[] = [];
    let flippedCards: HTMLDivElement[] = [];
    let matchedPairs = 0;
    let isLocked = false;

    // 1P State
    let moves = 0;
    let time = 0;
    let timerInterval: number | null = null;

    // 2P State
    let currentPlayer = 1;
    let scores: Record<number, number> = { 1: 0, 2: 0 };

    const emojis = ["ðŸŽ", "ðŸŒ", "ðŸ’", "ðŸ‡", "ðŸ‰", "ðŸ“", "ðŸ", "ðŸ¥"];

    // Init
    btn1p.addEventListener("click", () => startGame("1p"));
    btn2p.addEventListener("click", () => startGame("2p"));
    restartBtn.addEventListener("click", () => startGame(mode));
    backBtn.addEventListener("click", showMenu);

    function showMenu() {
      stopTimer();
      modeSelection.classList.remove("hidden");
      gameArea.classList.add("hidden");
      gameOverModal.classList.add("hidden");
    }

    function startGame(selectedMode: GameMode) {
      mode = selectedMode;
      modeSelection.classList.add("hidden");
      gameArea.classList.remove("hidden");
      gameOverModal.classList.add("hidden");

      // Reset State
      cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
      flippedCards = [];
      matchedPairs = 0;
      isLocked = false;

      // Reset UI
      grid.innerHTML = "";
      cards.forEach((emoji, index) => {
        const card = document.createElement("div");
        card.className =
          "w-16 h-16 sm:w-20 sm:h-20 bg-blue-500 rounded-lg cursor-pointer flex items-center justify-center text-4xl shadow-md hover:scale-105 transition-transform duration-200";
        card.dataset.emoji = emoji;
        card.dataset.index = index.toString();
        card.innerHTML = `<span class="hidden">${emoji}</span><span class="text-white font-bold text-2xl">?</span>`;
        card.addEventListener("click", flipCard);
        grid.appendChild(card);
      });

      if (mode === "1p") {
        hud1p.classList.remove("hidden");
        hud2p.classList.add("hidden");
        moves = 0;
        time = 0;
        movesDisplay.textContent = "0";
        timerDisplay.textContent = "00:00";
        startTimer();
      } else {
        hud1p.classList.add("hidden");
        hud2p.classList.remove("hidden");
        currentPlayer = 1;
        scores = { 1: 0, 2: 0 };
        updateScoreUI();
      }
    }

    function flipCard(this: HTMLDivElement) {
      if (isLocked) return;
      if (
        this.classList.contains("flipped") ||
        this.classList.contains("matched")
      )
        return;

      this.classList.add(
        "flipped",
        "bg-white",
        "dark:bg-gray-700",
        "border-2",
        "border-blue-500",
      );
      this.classList.remove("bg-blue-500");
      const firstSpan = this.querySelector("span:first-child");
      const lastSpan = this.querySelector("span:last-child");
      if (firstSpan) firstSpan.classList.remove("hidden");
      if (lastSpan) lastSpan.classList.add("hidden");

      flippedCards.push(this);

      if (flippedCards.length === 2) {
        checkMatch();
      }
    }

    function checkMatch() {
      isLocked = true;
      const [card1, card2] = flippedCards;
      const match = card1.dataset.emoji === card2.dataset.emoji;

      if (mode === "1p") {
        moves++;
        movesDisplay.textContent = moves.toString();
      }

      if (match) {
        handleMatch(card1, card2);
      } else {
        handleMismatch(card1, card2);
      }
    }

    function handleMatch(card1: HTMLDivElement, card2: HTMLDivElement) {
      card1.classList.add("matched", "opacity-50");
      card2.classList.add("matched", "opacity-50");
      flippedCards = [];
      matchedPairs++;
      isLocked = false;

      if (mode === "2p") {
        scores[currentPlayer]++;
        updateScoreUI();
        // Player keeps turn
      }

      if (matchedPairs === emojis.length) {
        endGame();
      }
    }

    function handleMismatch(card1: HTMLDivElement, card2: HTMLDivElement) {
      setTimeout(() => {
        card1.classList.remove(
          "flipped",
          "bg-white",
          "dark:bg-gray-700",
          "border-2",
          "border-blue-500",
        );
        card1.classList.add("bg-blue-500");
        const c1First = card1.querySelector("span:first-child");
        const c1Last = card1.querySelector("span:last-child");
        if (c1First) c1First.classList.add("hidden");
        if (c1Last) c1Last.classList.remove("hidden");

        card2.classList.remove(
          "flipped",
          "bg-white",
          "dark:bg-gray-700",
          "border-2",
          "border-blue-500",
        );
        card2.classList.add("bg-blue-500");
        const c2First = card2.querySelector("span:first-child");
        const c2Last = card2.querySelector("span:last-child");
        if (c2First) c2First.classList.add("hidden");
        if (c2Last) c2Last.classList.remove("hidden");

        flippedCards = [];
        isLocked = false;

        if (mode === "2p") {
          currentPlayer = currentPlayer === 1 ? 2 : 1;
          updateScoreUI();
        }
      }, 1000);
    }

    function updateScoreUI() {
      p1ScoreDisplay.textContent = `J1: ${scores[1]}`;
      p2ScoreDisplay.textContent = `J2: ${scores[2]}`;

      if (currentPlayer === 1) {
        p1ScoreDisplay.classList.add("text-blue-500", "font-bold");
        p1ScoreDisplay.classList.remove("text-gray-500");
        p2ScoreDisplay.classList.add("text-gray-500");
        p2ScoreDisplay.classList.remove("text-red-500", "font-bold");
        turnIndicator.innerHTML =
          'Turno de: <span class="text-blue-500">J1</span>';
      } else {
        p2ScoreDisplay.classList.add("text-red-500", "font-bold");
        p2ScoreDisplay.classList.remove("text-gray-500");
        p1ScoreDisplay.classList.add("text-gray-500");
        p1ScoreDisplay.classList.remove("text-blue-500", "font-bold");
        turnIndicator.innerHTML =
          'Turno de: <span class="text-red-500">J2</span>';
      }
    }

    function startTimer() {
      stopTimer();
      timerInterval = window.setInterval(() => {
        time++;
        const minutes = Math.floor(time / 60)
          .toString()
          .padStart(2, "0");
        const seconds = (time % 60).toString().padStart(2, "0");
        timerDisplay.textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
    }

    function endGame() {
      stopTimer();
      gameOverModal.classList.remove("hidden");

      if (mode === "1p") {
        resultMessage.innerHTML = `Completado en <b>${timerDisplay.textContent}</b> con <b>${moves}</b> movimientos.`;
      } else {
        if (scores[1] > scores[2]) {
          resultMessage.innerHTML = `Â¡Gana el <span class="text-blue-500">Jugador 1</span> con ${scores[1]} parejas!`;
        } else if (scores[2] > scores[1]) {
          resultMessage.innerHTML = `Â¡Gana el <span class="text-red-500">Jugador 2</span> con ${scores[2]} parejas!`;
        } else {
          resultMessage.innerHTML = `Â¡Empate a ${scores[1]} parejas!`;
        }
      }
    }
  </script>
</Layout>
